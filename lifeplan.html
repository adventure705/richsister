<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¸ìƒ ë¡œë“œë§µ 30ë…„ ì‹œë‚˜ë¦¬ì˜¤</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#fef2f4',
              100: '#fde6e9',
              200: '#fbd0d9',
              300: '#f7a9ba',
              400: '#f17392',
              500: '#e5456f',
              600: '#af1d42', // Base Color
              700: '#af1d42',
              800: '#911a39',
              900: '#7a1a33',
              950: '#440a18',
            }
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          }
        }
      }
    }
  </script>
  <!-- React & Babel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Icons (Lucide) -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Excel (ExcelJS) -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <style>
    @import url('https://cdn.jsdelivr.net/gh/moonspam/NanumSquare@2.0/nanumsquare.css');

    body {
      font-family: 'NanumSquare', sans-serif;
    }

    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }

    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .modal-overlay {
      background-color: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
    }

    .animate-in {
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }
  </style>
</head>

<body>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCK_FPWI4TIDOJQ1TQ1lYN-QwO-D1Gw2fg",
      authDomain: "richsister-5cf8c.firebaseapp.com",
      projectId: "richsister-5cf8c",
      storageBucket: "richsister-5cf8c.firebasestorage.app",
      messagingSenderId: "773702207866",
      appId: "1:773702207866:web:87e277b70f7bf188892ec3",
      measurementId: "G-B51PDEQYX9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // ë¦¬ì•¡íŠ¸ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì „ì—­ì— ë…¸ì¶œ
    window.fb = {
      auth,
      db,
      provider,
      signInWithPopup,
      signOut,
      onAuthStateChanged,
      doc,
      getDoc,
      setDoc,
      onSnapshot
    };

    // ë¡œë“œ ì™„ë£Œ ì´ë²¤íŠ¸ ë°œìƒ (ì˜µì…˜)
    window.dispatchEvent(new Event('firebase-loaded'));
  </script>

  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    // ì•„ì´ì½˜ ì»´í¬ë„ŒíŠ¸ (ì•ˆì „ ëª¨ë“œ)
    const Icon = ({ name, size = 20, className = "" }) => {
      const emojis = {
        'save': 'ğŸ’¾', 'table-2': 'ğŸ“Š', 'image-plus': 'ğŸ–¼ï¸',
        'cloud-download': 'â˜ï¸', 'log-out': 'ğŸšª', 'log-in': 'ğŸ”‘',
        'layers': 'â•', 'history': 'ğŸ•’', 'sun': 'â˜€ï¸', 'moon': 'ğŸŒ™',
        'book-open': 'ğŸ“–', 'calendar': 'ğŸ“…', 'user': 'ğŸ‘¤',
        'check-circle': 'âœ…', 'alert-triangle': 'âš ï¸', 'info': 'â„¹ï¸', 'database-zap': 'âš¡', 'cpu': 'ğŸ¤–',
        'chevron-left': 'â—€ï¸', 'chevron-right': 'â–¶ï¸'
      };
      // ìš°ì„  í™”ë©´ ë³µêµ¬ë¥¼ ìœ„í•´ SVG ë Œë”ë§ì„ ì¤‘ë‹¨í•˜ê³  ì´ëª¨ì§€ë§Œ ë³´ì—¬ì¤ë‹ˆë‹¤.
      return <span style={{ fontSize: size, lineHeight: 1 }} className={className}>{emojis[name] || ''}</span>;
    };

    // ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸
    const Modal = ({ isOpen, onClose, title, children, maxWidth = "max-w-md" }) => {
      useEffect(() => {
        const handleEsc = (e) => {
          if (e.key === 'Escape') onClose();
        };
        if (isOpen) window.addEventListener('keydown', handleEsc);
        return () => window.removeEventListener('keydown', handleEsc);
      }, [isOpen, onClose]);

      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay overflow-y-auto" onClick={onClose}>
          <div
            className={`bg-white dark:bg-slate-900 rounded-[2rem] w-full ${maxWidth} shadow-2xl animate-in overflow-hidden border border-slate-200 dark:border-slate-800`}
            onClick={e => e.stopPropagation()}
          >
            {title && (
              <div className="px-8 py-6 border-b border-slate-100 dark:border-brand-900/30 flex justify-between items-center bg-brand-50/30 dark:bg-brand-950/40">
                <h3 className="text-xl font-black text-brand-700 dark:text-brand-300">{title}</h3>
                <button onClick={onClose} className="text-brand-400 hover:text-brand-600 dark:hover:text-brand-200 transition-colors">
                  <Icon name="x" size={24} />
                </button>
              </div>
            )}
            <div className={title ? "p-8" : "p-2"}>
              {!title && (
                <button onClick={onClose} className="absolute top-6 right-6 z-10 bg-black/50 text-white p-2 rounded-full hover:bg-black/70 transition-colors">
                  <Icon name="x" size={24} />
                </button>
              )}
              {children}
            </div>
            {/* Footer / Version Info & Diagnostics */}
            <div className="fixed bottom-2 right-4 flex gap-4 items-center z-50">
              <button
                onClick={() => {
                  const dataCount = Object.keys(yearDataStore).length;
                  const sample = dataCount > 0 ? JSON.stringify(yearDataStore[2026] || Object.values(yearDataStore)[0], null, 2) : "ì—†ìŒ";
                  alert(`[ë°ì´í„° ì§„ë‹¨]\n- ë¡œê·¸ì¸: ${currentUser ? "ì„±ê³µ (" + currentUser.email + ")" : "ì‹¤íŒ¨"}\n- ì €ì¥ëœ ì—°ë„ ë°ì´í„° ìˆ˜: ${dataCount}ê°œ\n- í˜„ì¬ í™”ë©´ ë°ì´í„° ìˆ˜: ${items.length}ê°œ\n\n[ìƒ˜í”Œ ë°ì´í„°]\n${sample}`);
                }}
                className="text-[10px] text-slate-400 font-bold hover:text-brand-500 underline"
              >
                ë°ì´í„° ì§„ë‹¨
              </button>
              <span className="text-[10px] text-slate-300 dark:text-slate-700 font-mono pointer-events-none opacity-50">
                v1.3 (Secure Sync)
              </span>
            </div>
          </div>
        </div>
      );
    };

    const App = () => {
      const roadmapRef = useRef(null);
      const fileInputRef = useRef(null);

      const [activeCell, setActiveCell] = useState(null);
      const [darkMode, setDarkMode] = useState(false);

      // Firebase User State
      const [currentUser, setCurrentUser] = useState(null);
      const [isAuthChecking, setIsAuthChecking] = useState(true);

      // Firestore ì €ì¥/ë¡œë“œ í—¬í¼ í•¨ìˆ˜
      // Firestore ì €ì¥/ë¡œë“œ í—¬í¼ í•¨ìˆ˜
      const saveToFirestore = async (user, data) => {
        if (!user || !window.fb) throw new Error("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

        // ë°ì´í„° í¬ê¸° ëŒ€ëµì  ì²´í¬ (Firestore 1MB ì œí•œ)
        const jsonString = JSON.stringify(data);
        const sizeInBytes = new Blob([jsonString]).size;
        if (sizeInBytes > 1000000) {
          throw new Error(`ë°ì´í„° ìš©ëŸ‰ì´ ë„ˆë¬´ í½ë‹ˆë‹¤ (${(sizeInBytes / 1024 / 1024).toFixed(2)}MB).\nì´ë¯¸ì§€ë¥¼ ì¤„ì´ê±°ë‚˜ ì‚­ì œí•´ì£¼ì„¸ìš”. (ìµœëŒ€ 1MB)`);
        }

        const docRef = window.fb.doc(window.fb.db, "users", user.uid);
        await window.fb.setDoc(docRef, {
          roadmap: data,
          updatedAt: new Date().toISOString(),
          uid: user.uid,
          email: user.email
        }, { merge: true });
      };

      // ë°ì´í„° ì ìš© í—¬í¼ í•¨ìˆ˜
      const applyDataToState = (data) => {
        if (!data) return;
        if (data.pageTitle) setPageTitle(data.pageTitle);
        if (data.pageSubtitle) setPageSubtitle(data.pageSubtitle);
        if (data.startAge) setStartAge(data.startAge);
        if (data.startYear) setStartYear(data.startYear);
        if (data.defaultReturn) setDefaultReturn(data.defaultReturn);
        if (data.defaultSavings) setDefaultSavings(data.defaultSavings);
        if (data.goalTitle) setGoalTitle(data.goalTitle);
        if (data.goalQuote) setGoalQuote(data.goalQuote);
        if (data.savingsUnit) setSavingsUnit(data.savingsUnit);
        if (data.allRows) setAllRows(data.allRows);
        if (data.items) setItems(data.items);
        if (data.yearDataStore) setYearDataStore(data.yearDataStore);
        if (data.darkMode !== undefined) setDarkMode(data.darkMode);
      };

      // App ë‚´ë¶€ì—ì„œ ì‚¬ìš©í•  ë¡œë“œ í•¨ìˆ˜ (ìˆ˜ë™ ë¡œë“œìš©)
      const loadFromFirestore = async (user, isManual = false) => {
        if (!user || !window.fb) return;
        if (isManual) {
          setModalState({ type: 'status', data: { title: "ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘", msg: "í´ë¼ìš°ë“œì—ì„œ ë°ì´í„°ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...", icon: "loader", animate: true } });
        }

        try {
          const docRef = window.fb.doc(window.fb.db, "users", user.uid);
          const docSnap = await window.fb.getDoc(docRef);

          if (docSnap.exists()) {
            const data = docSnap.data().roadmap;
            if (data) {
              applyDataToState(data);
              setModalState({ type: 'status', data: { title: "ë™ê¸°í™” ì™„ë£Œ", msg: "í´ë¼ìš°ë“œì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.", icon: "cloud" } });
            }
          } else {
            if (isManual) {
              setModalState({ type: 'status', data: { title: "ë°ì´í„° ì—†ìŒ", msg: "ì„œë²„ì— ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € [ì €ì¥]ì„ í•´ì£¼ì„¸ìš”.", icon: "alert-circle" } });
            }
          }
        } catch (e) {
          console.error("Firestore load error:", e);
          if (isManual || e.code === 'permission-denied') {
            setModalState({ type: 'status', data: { title: "ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", msg: `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}\n(ê¶Œí•œ ë¬¸ì œì¼ ê²½ìš° Firebase Console ê·œì¹™ì„ í™•ì¸í•˜ì„¸ìš”)`, icon: "alert-triangle" } });
          }
        }
      };

      // ì¸ì¦ ë¦¬ìŠ¤ë„ˆ ë° ì´ˆê¸° ë°ì´í„° ë¡œë”© ë³´ì¥
      useEffect(() => {
        let unsubscribeSnapshot = null;

        const initFirebase = async () => {
          if (window.fb) {
            window.fb.onAuthStateChanged(window.fb.auth, async (user) => {
              setCurrentUser(user);

              if (unsubscribeSnapshot) {
                unsubscribeSnapshot();
                unsubscribeSnapshot = null;
              }

              if (user) {
                // 1. [ì¤‘ìš”] ì´ˆê¸° ë°ì´í„° "ë°˜ë“œì‹œ" ê°€ì ¸ì˜¤ê¸° (ì´ê±° ëë‚  ë•Œê¹Œì§€ ë¡œë”© ì•ˆ í’ˆ)
                try {
                  const docRef = window.fb.doc(window.fb.db, "users", user.uid);

                  // ë©”íƒ€ë°ì´í„° í¬í•¨í•´ì„œ 1íšŒ ì¡°íšŒ
                  const docSnap = await window.fb.getDoc(docRef);
                  if (docSnap.exists()) {
                    applyDataToState(docSnap.data().roadmap);
                  } else {
                    // ì‹ ê·œ ìœ ì €(ë°ì´í„° ì—†ìŒ)ì¸ ê²½ìš° ì´ˆê¸°í™”
                    resetState();
                  }
                } catch (e) {
                  console.error("Initial load error", e);
                }

                // 2. ë°ì´í„° ì„¸íŒ…ì´ ëë‚¬ìœ¼ë‹ˆ ì´ì œì•¼ ë¡œë”© í•´ì œ (í™”ë©´ ì˜¤í”ˆ!)
                setIsAuthChecking(false);

                // 3. ê·¸ ë’¤ì— ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì—°ê²° (ë¯¸ë˜ì˜ ë³€ê²½ì‚¬í•­ ìˆ˜ì‹ ìš©)
                try {
                  const docRef = window.fb.doc(window.fb.db, "users", user.uid);
                  unsubscribeSnapshot = window.fb.onSnapshot(docRef, { includeMetadataChanges: true }, (doc) => {
                    if (doc.exists()) {
                      applyDataToState(doc.data().roadmap);
                    }
                  });
                } catch (e) { console.error(e); }

              } else {
                setIsAuthChecking(false);
              }
            });
          } else {
            setTimeout(initFirebase, 200);
          }
        };
        initFirebase();

        return () => {
          if (unsubscribeSnapshot) unsubscribeSnapshot();
        };
      }, []);

      const handleLogin = async () => {
        if (!window.fb) return;
        try {
          await window.fb.signInWithPopup(window.fb.auth, window.fb.provider);
        } catch (error) {
          console.error("Login failed", error);
          setModalState({ type: 'status', data: { title: "ë¡œê·¸ì¸ ì‹¤íŒ¨", msg: error.message, icon: "alert-triangle" } });
        }
      };

      const resetState = () => {
        setPageTitle('ì¸ìƒ ë¡œë“œë§µ 30ë…„ ì‹œë‚˜ë¦¬ì˜¤');
        setPageSubtitle('ì›í•˜ëŠ” ì—°ë„ì™€ ë‚˜ì´ë¡œ ë‹¹ì‹ ì˜ 30ë…„ì„ ê·¸ë ¤ë³´ì„¸ìš”.');
        setStartAge(30);
        setStartYear(new Date().getFullYear());
        setDefaultReturn(15);
        setDefaultSavings(820);
        setGoalTitle('ë‚˜ì˜ ì¸ìƒ ëª©í‘œ');
        setGoalQuote('"ì„±ê³µì€ ê³„íšì—ì„œ ì‹œì‘ëœë‹¤"');
        setSavingsUnit('ë§Œì›');
        setAllRows([
          { id: 'beginningAssets', label: 'ì—°ì´ˆìì‚°', type: 'number', isSystem: true },
          { id: 'investedAssets', label: 'íˆ¬ììì‚°', type: 'number', isSystem: true },
          { id: 'targetReturn', label: 'ìˆ˜ìµë¥  (%)', type: 'number', isSystem: true },
          { id: 'savings', label: 'ì €ì¶•ì•¡', type: 'number', isSystem: true },
          { id: 'yearEndAssets', label: 'ì—°ë§ìì‚°', type: 'calculated', isSystem: true },
          { id: 'lifePlan', label: 'ë¼ì´í”„ í”Œëœ', type: 'textarea' },
          { id: 'visualization', label: 'ì‹œê°í™”', type: 'image' }
        ]);
        setYearDataStore({});
        setDarkMode(false);
      };



      // í—¤ë” ë° ì•ˆë‚´ ë¬¸êµ¬ ìƒíƒœ
      const [pageTitle, setPageTitle] = useState('ì¸ìƒ ë¡œë“œë§µ 30ë…„ ì‹œë‚˜ë¦¬ì˜¤');
      const [pageSubtitle, setPageSubtitle] = useState('ì›í•˜ëŠ” ì—°ë„ì™€ ë‚˜ì´ë¡œ ë‹¹ì‹ ì˜ 30ë…„ì„ ê·¸ë ¤ë³´ì„¸ìš”.');

      const [startAge, setStartAge] = useState(30);
      const [startYear, setStartYear] = useState(new Date().getFullYear());
      const [defaultReturn, setDefaultReturn] = useState(15);
      const [defaultSavings, setDefaultSavings] = useState(820);
      const [goalTitle, setGoalTitle] = useState('ë‚˜ì˜ ì¸ìƒ ëª©í‘œ');
      const [goalQuote, setGoalQuote] = useState('"ì„±ê³µì€ ê³„íšì—ì„œ ì‹œì‘ëœë‹¤"');
      const [savingsUnit, setSavingsUnit] = useState('ë§Œì›');

      const [allRows, setAllRows] = useState([
        { id: 'beginningAssets', label: 'ì—°ì´ˆìì‚°', type: 'number', isSystem: true },
        { id: 'investedAssets', label: 'íˆ¬ììì‚°', type: 'number', isSystem: true },
        { id: 'targetReturn', label: 'ìˆ˜ìµë¥  (%)', type: 'number', isSystem: true },
        { id: 'savings', label: 'ì €ì¶•ì•¡', type: 'number', isSystem: true },
        { id: 'yearEndAssets', label: 'ì—°ë§ìì‚°', type: 'calculated', isSystem: true },
        { id: 'lifePlan', label: 'ë¼ì´í”„ í”Œëœ', type: 'textarea' },
        { id: 'visualization', label: 'ì‹œê°í™”', type: 'image' }
      ]);

      // ì—°ë„ë³„ ë°ì´í„° ë§ˆìŠ¤í„° ì €ì¥ì†Œ (ì—°ë„ ì´ë™ ì‹œ ë³µì›ìš©)
      const [yearDataStore, setYearDataStore] = useState({});

      // [ì¤‘ìš”] ë¹„ë™ê¸° í•¨ìˆ˜(ì €ì¥/ìë™ì €ì¥)ì—ì„œ ìµœì‹  ìƒíƒœë¥¼ ì°¸ì¡°í•˜ê¸° ìœ„í•œ Ref
      const latestStateRef = useRef({
        pageTitle, pageSubtitle, startAge, startYear,
        defaultReturn, defaultSavings, goalTitle, goalQuote,
        savingsUnit, allRows, yearDataStore, items, darkMode
      });

      useEffect(() => {
        latestStateRef.current = {
          pageTitle, pageSubtitle, startAge, startYear,
          defaultReturn, defaultSavings, goalTitle, goalQuote,
          savingsUnit, allRows, yearDataStore, items, darkMode
        };
      }, [pageTitle, pageSubtitle, startAge, startYear, defaultReturn, defaultSavings, goalTitle, goalQuote, savingsUnit, allRows, yearDataStore, items, darkMode]);

      // ì‹¤í–‰ ì·¨ì†Œ / ë‹¤ì‹œ ì‹¤í–‰ ìŠ¤íƒ
      const [undoStack, setUndoStack] = useState([]);
      const [redoStack, setRedoStack] = useState([]);

      const takeSnapshot = () => {
        const snapshot = {
          pageTitle, pageSubtitle, startAge, startYear,
          defaultReturn, defaultSavings, goalTitle, goalQuote,
          savingsUnit, allRows, yearDataStore, items, darkMode
        };
        setUndoStack(prev => [...prev.slice(-49), snapshot]); // ìµœëŒ€ 50ê°œ ì €ì¥
        setRedoStack([]);
      };

      const applySnapshot = (snapshot) => {
        setPageTitle(snapshot.pageTitle);
        setPageSubtitle(snapshot.pageSubtitle);
        setStartAge(snapshot.startAge);
        setStartYear(snapshot.startYear);
        setDefaultReturn(snapshot.defaultReturn);
        setDefaultSavings(snapshot.defaultSavings);
        setGoalTitle(snapshot.goalTitle);
        setGoalQuote(snapshot.goalQuote);
        setSavingsUnit(snapshot.savingsUnit);
        setAllRows(snapshot.allRows);
        setYearDataStore(snapshot.yearDataStore);
        setItems(snapshot.items);
        setDarkMode(snapshot.darkMode);
      };

      const handleUndo = () => {
        if (undoStack.length === 0) return;
        const current = {
          pageTitle, pageSubtitle, startAge, startYear,
          defaultReturn, defaultSavings, goalTitle, goalQuote,
          savingsUnit, allRows, yearDataStore, items, darkMode
        };
        const previous = undoStack[undoStack.length - 1];
        setRedoStack(prev => [...prev, current]);
        setUndoStack(prev => prev.slice(0, -1));
        applySnapshot(previous);
      };

      const handleRedo = () => {
        if (redoStack.length === 0) return;
        const current = {
          pageTitle, pageSubtitle, startAge, startYear,
          defaultReturn, defaultSavings, goalTitle, goalQuote,
          savingsUnit, allRows, yearDataStore, items, darkMode
        };
        const next = redoStack[redoStack.length - 1];
        setUndoStack(prev => [...prev, current]);
        setRedoStack(prev => prev.slice(0, -1));
        applySnapshot(next);
      };

      // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ë¡œì§ ì œê±° (í´ë¼ìš°ë“œ ì „ìš©)
      /* useEffect(() => { ... }, [yearDataStore]); ì‚­ì œë¨ */

      const [history, setHistory] = useState([]);

      const createBackup = async (isAuto = false) => {
        // [ì¤‘ìš”] ìµœì‹  ìƒíƒœ(Ref)ë¥¼ ì‚¬ìš©í•˜ì—¬ ìŠ¤ëƒ…ìƒ· ìƒì„±
        const currentData = latestStateRef.current;
        const snapshot = {
          id: Date.now(),
          timestamp: new Date().toLocaleString('ko-KR', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
          }),
          isAuto,
          data: currentData
        };

        // ë¡œì»¬ íˆìŠ¤í† ë¦¬(ë©”ëª¨ë¦¬) ì—…ë°ì´íŠ¸
        setHistory(prev => {
          const newHistory = [snapshot, ...prev].slice(0, 100);
          return newHistory;
        });

        // í´ë¼ìš°ë“œ ì €ì¥
        if (currentUser) {
          if (!isAuto) {
            setModalState({ type: 'status', data: { title: "í´ë¼ìš°ë“œ ì €ì¥ ì¤‘", msg: "ë°ì´í„°ë¥¼ ì•ˆì „í•œ ì„œë²„ë¡œ ì „ì†¡í•˜ê³  ìˆìŠµë‹ˆë‹¤...", icon: "loader", animate: true } });
          }

          try {
            await saveToFirestore(currentUser, snapshot.data);

            if (!isAuto) {
              setModalState({ type: 'status', data: { title: "ì €ì¥ ì„±ê³µ", msg: "ë°ì´í„°ê°€ í´ë¼ìš°ë“œì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", icon: "check-circle" } });
            }
          } catch (e) {
            console.error("Cloud save failed:", e);
            if (!isAuto) {
              setModalState({ type: 'status', data: { title: "âš ï¸ í´ë¼ìš°ë“œ ì €ì¥ ì‹¤íŒ¨", msg: `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}\n(Firebase ë³´ì•ˆ ê·œì¹™ í˜¹ì€ ìš©ëŸ‰ ì´ˆê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”)`, icon: "alert-triangle" } });
            }
          }
        } else {
          // ë¹„ë¡œê·¸ì¸ ìƒíƒœë©´ ê²½ê³ 
          if (!isAuto) {
            setModalState({ type: 'status', data: { title: "ì„ì‹œ ì €ì¥ ì™„ë£Œ", msg: "ë°ì´í„°ê°€ ì„ì‹œë¡œ ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\nâš ï¸ ì£¼ì˜: ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ì°½ì„ ë‹«ìœ¼ë©´ ë°ì´í„°ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.\në¡œê·¸ì¸í•˜ì—¬ í´ë¼ìš°ë“œì— ì•ˆì „í•˜ê²Œ ì €ì¥í•˜ì„¸ìš”.", icon: "alert-circle" } });
          }
        }
      };

      const restoreBackup = (backup) => {
        const { data } = backup;
        setPageTitle(data.pageTitle);
        setPageSubtitle(data.pageSubtitle);
        setStartAge(data.startAge);
        setStartYear(data.startYear);
        setDefaultReturn(data.defaultReturn);
        setDefaultSavings(data.defaultSavings);
        setGoalTitle(data.goalTitle);
        setGoalQuote(data.goalQuote);
        setSavingsUnit(data.savingsUnit);
        setAllRows(data.allRows);
        setItems(data.items);
        setDarkMode(data.darkMode);
        closeModal();
        setModalState({ type: 'status', data: { title: "ë³µêµ¬ ì™„ë£Œ", msg: `${backup.timestamp} ì‹œì ì˜ ë°ì´í„°ë¡œ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.`, icon: "refresh-cw" } });
      };

      // ë‹¨ì¶•í‚¤ ë° ìë™ ì €ì¥
      useEffect(() => {
        const handleKeyDown = (e) => {
          if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            createBackup(false);
          }
          if ((e.ctrlKey || e.metaKey) && !e.shiftKey && e.key === 'z') {
            e.preventDefault();
            handleUndo();
          }
          if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'z') {
            e.preventDefault();
            handleRedo();
          }
        };
        window.addEventListener('keydown', handleKeyDown);

        // 5ë¶„ë§ˆë‹¤ ìë™ ì €ì¥
        const autoSaveTimer = setInterval(() => {
          createBackup(true);
        }, 5 * 60 * 1000);

        return () => {
          window.removeEventListener('keydown', handleKeyDown);
          clearInterval(autoSaveTimer);
        };
      }, [pageTitle, pageSubtitle, startAge, startYear, defaultReturn, defaultSavings, goalTitle, goalQuote, savingsUnit, allRows, items, darkMode]);

      const handleLogout = async () => {
        if (!window.fb) return;
        try {
          // [ì¤‘ìš”] ë¡œê·¸ì•„ì›ƒ ì „ ë§ˆì§€ë§‰ ë°ì´í„° ìë™ ì €ì¥
          setModalState({ type: 'status', data: { title: "ë¡œê·¸ì•„ì›ƒ ì¤‘", msg: "ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤...", icon: "save", animate: true } });

          if (currentUser) {
            await createBackup(true);
          }

          await window.fb.signOut(window.fb.auth);
          setCurrentUser(null);
          resetState();
          setModalState({ type: 'status', data: { title: "ë¡œê·¸ì•„ì›ƒ", msg: "ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  ì•ˆì „í•˜ê²Œ ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.", icon: "check-circle" } });
        } catch (error) {
          console.error("Logout failed", error);
          setModalState({ type: 'status', data: { title: "ì˜¤ë¥˜", msg: "ë¡œê·¸ì•„ì›ƒ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", icon: "alert-triangle" } });
        }
      };

      const calculateYearEndAssets = (item) => {
        const beg = Number(item.beginningAssets) || 0;
        const inv = Number(item.investedAssets) || 0;
        const sav = Number(item.savings) || 0;
        const retPercent = Number(item.targetReturn) || 0;
        const profit = inv * (retPercent / 100);

        let total = beg + profit + sav;

        // ì¶”ê°€ëœ ìˆ«ì í–‰ë“¤ ì¤‘ ì—°ì‚° ì„¤ì •ëœ í•­ëª© ë°˜ì˜
        allRows.forEach(row => {
          if (row.type === 'number' && !row.isSystem && row.operator) {
            const val = Number(item.dynamicData?.[row.id]) || 0;
            if (row.operator === 'add') total += val;
            else if (row.operator === 'subtract') total -= val;
          }
        });

        return Math.round(total);
      };

      const [items, setItems] = useState(() => {
        const arr = Array.from({ length: 30 }, (_, i) => {
          const year = startYear + i;
          const store = yearDataStore?.[year] || {};
          return {
            beginningAssets: store.beginningAssets !== undefined ? store.beginningAssets : 0,
            investedAssets: store.investedAssets !== undefined ? store.investedAssets : 0,
            savings: store.savings !== undefined ? store.savings : 820,
            targetReturn: store.targetReturn !== undefined ? store.targetReturn : 15,
            dynamicData: store.dynamicData || {}
          };
        });
        // Removed forced initialization of beginningAssets
        for (let i = 0; i < arr.length - 1; i++) {
          arr[i + 1].beginningAssets = calculateYearEndAssets(arr[i]);
        }
        return arr;
      });

      // ì—°ë„ ì´ë™ ì‹œ ë°ì´í„° ë³µì› ë° ë™ê¸°í™” (ì—°ì†ì„± í™•ë³´ ë²„ì „)
      useEffect(() => {
        setItems(prev => {
          // 1. ê¸°ì¤€ì—°ë„(2026)ë¶€í„° ë§ˆì§€ë§‰ ê°€ìš© ì—°ë„ê¹Œì§€ì˜ ì „ì—­ ë°ì´í„° íë¦„ ê³„ì‚°
          const baseYear = 2026;
          const endYear = startYear + 30;
          const fullTimeline = {};

          // ì‹œë®¬ë ˆì´ì…˜: ê¸°ì¤€ì ë¶€í„° í˜„ì¬ í™”ë©´ ëê¹Œì§€ ê³„ì‚°
          let currentBeg = yearDataStore[baseYear]?.beginningAssets !== undefined ? yearDataStore[baseYear].beginningAssets : 0;

          for (let y = baseYear; y <= endYear; y++) {
            const store = yearDataStore[y] || {};
            const inv = store.investedAssets !== undefined ? store.investedAssets : 0;
            const sav = store.savings !== undefined ? store.savings : defaultSavings;
            const ret = store.targetReturn !== undefined ? store.targetReturn : defaultReturn;

            // ë§Œì•½ í•´ë‹¹ ì—°ë„ì— ìˆ˜ë™ìœ¼ë¡œ ì—°ì´ˆìì‚°ì„ ë„£ì—ˆë‹¤ë©´ í•´ë‹¹ ê°’ ì‚¬ìš©
            if (store.beginningAssets !== undefined) currentBeg = store.beginningAssets;

            const yearEnd = Math.round(currentBeg + (inv * (ret / 100)) + sav);

            // ì¤‘ìš”: allRowsë¥¼ ìˆœíšŒí•˜ë©° dynamicDataì— ë”°ë¥¸ ì¶”ê°€ ì—°ì‚° ìˆ˜í–‰
            let finalYearEnd = yearEnd;
            if (store.dynamicData) {
              allRows.forEach(row => {
                if (row.type === 'number' && !row.isSystem && row.operator) {
                  const val = Number(store.dynamicData[row.id]) || 0;
                  if (row.operator === 'add') finalYearEnd += val;
                  else if (row.operator === 'subtract') finalYearEnd -= val;
                }
              });
            }

            fullTimeline[y] = {
              beginningAssets: currentBeg,
              investedAssets: inv,
              savings: sav,
              targetReturn: ret,
              yearEndAssets: finalYearEnd,
              dynamicData: store.dynamicData || {}
            };

            // ë‹¤ìŒ ì—°ë„ì˜ ì—°ì´ˆ ìì‚°ì€ í˜„ì¬ ì—°ë„ì˜ ì—°ë§ ìì‚°
            currentBeg = finalYearEnd;
          }

          // 2. í˜„ì¬ startYear ì‹œì ì— í•´ë‹¹í•˜ëŠ” 30ë…„ì¹˜ ë°ì´í„° ìŠ¬ë¼ì´ì‹±
          const newItems = Array.from({ length: 30 }, (_, i) => {
            const year = startYear + i;
            // yearDataStoreì— ìˆëŠ” ë°ì´í„°ê°€ ìš°ì„ 
            const calculated = fullTimeline[year];
            if (calculated) return calculated;

            return {
              beginningAssets: 0,
              investedAssets: 0,
              savings: defaultSavings,
              targetReturn: defaultReturn,
              dynamicData: {}
            };
          });

          return newItems;
        });
      }, [startYear, defaultReturn, defaultSavings, yearDataStore, allRows]);

      const [modalState, setModalState] = useState({
        type: null, // 'header', 'addRow', 'editRow'
        data: null
      });

      const [draggedRowIndex, setDraggedRowIndex] = useState(null);
      const [globalRowHeight, setGlobalRowHeight] = useState(80);

      const startResizing = (e) => {
        e.preventDefault();
        const startY = e.pageY;
        const startHeight = globalRowHeight;

        const onMouseMove = (moveEvent) => {
          const deltaY = moveEvent.pageY - startY;
          setGlobalRowHeight(Math.max(40, startHeight + deltaY));
        };

        const onMouseUp = () => {
          window.removeEventListener('mousemove', onMouseMove);
          window.removeEventListener('mouseup', onMouseUp);
          document.body.style.cursor = 'default';
        };

        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('mouseup', onMouseUp);
        document.body.style.cursor = 'row-resize';
      };

      // (ê¸°ì¡´ useEffectëŠ” ìœ„ë¡œ í†µí•©ë¨)

      const closeModal = () => setModalState({ type: null, data: null });

      const updateItem = (index, field, value) => {
        takeSnapshot();
        const year = startYear + index;
        const val = ['beginningAssets', 'investedAssets', 'savings', 'targetReturn'].includes(field) ? (Number(value) || 0) : value;

        // ë§ˆìŠ¤í„° ì €ì¥ì†Œ ì—…ë°ì´íŠ¸
        setYearDataStore(prev => ({
          ...prev,
          [year]: { ...prev[year], [field]: val }
        }));

        setItems(prev => {
          const newItems = prev.map((item, i) => {
            if (i === index) return { ...item, [field]: val };
            return item;
          });

          // ìºìŠ¤ì¼€ì´ë“œ ê³„ì‚° (ë¶ˆë³€ì„± ìœ ì§€)
          for (let i = index; i < newItems.length - 1; i++) {
            const nextYear = startYear + i + 1;
            // ë‹¤ìŒ ì—°ë„ì— ìˆ˜ë™ ì…ë ¥ëœ ì—°ì´ˆìì‚°(override)ì´ ì—†ì„ ë•Œë§Œ ìºìŠ¤ì¼€ì´ë“œ ì§„í–‰
            if (yearDataStore[nextYear]?.beginningAssets === undefined || i === index) {
              const nextBegValue = calculateYearEndAssets(newItems[i]);
              if (newItems[i + 1].beginningAssets !== nextBegValue) {
                newItems[i + 1] = { ...newItems[i + 1], beginningAssets: nextBegValue };
              } else {
                // ê°’ì´ ê°™ë‹¤ë©´ ì´í›„ ë³€í™”ê°€ ì—†ìœ¼ë¯€ë¡œ ì¤‘ë‹¨ ê°€ëŠ¥ (ìµœì í™”)
                if (i > index) break;
              }
            } else {
              break; // ìˆ˜ë™ ì…ë ¥ê°’ì„ ë§Œë‚˜ë©´ ìºìŠ¤ì¼€ì´ë“œ ì¤‘ë‹¨
            }
          }
          return newItems;
        });
      };

      const updateDynamicData = (index, rowId, value) => {
        takeSnapshot();
        const year = startYear + index;

        // í•´ë‹¹ í–‰ì´ ì—°ì‚°(+, -)ì— ì°¸ì—¬í•˜ëŠ” í–‰ì¸ì§€ í™•ì¸
        const rowDef = allRows.find(r => r.id === rowId);
        const isOperand = rowDef && rowDef.type === 'number' && rowDef.operator;
        const val = rowDef && rowDef.type === 'number' ? (Number(value) || 0) : value;

        // [ì¤‘ìš”] ë§ˆìŠ¤í„° ë°ì´í„° ìŠ¤í† ì–´(yearDataStore) ì—…ë°ì´íŠ¸
        setYearDataStore(prev => {
          const currentYearStore = prev[year] || {};
          return {
            ...prev,
            [year]: {
              ...currentYearStore,
              dynamicData: {
                ...(currentYearStore.dynamicData || {}),
                [rowId]: val
              }
            }
          };
        });

        // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (setItems)
        setItems(prev => {
          const newItems = prev.map((item, i) => {
            if (i === index) {
              return {
                ...item,
                dynamicData: { ...item.dynamicData, [rowId]: val }
              };
            }
            return item;
          });

          // ìì‚° ì—°ì‚°ì— ì°¸ì—¬í•˜ëŠ” í–‰ì¸ ê²½ìš°, ë¯¸ë˜ ì—°ë„ë“¤ì˜ ì—°ì´ˆìì‚° ê°€ë¡œì§ˆëŸ¬ ê³„ì‚°(Cascade)
          if (isOperand) {
            for (let i = index; i < newItems.length - 1; i++) {
              const nextYear = startYear + i + 1;
              // ë‹¤ìŒ ì—°ë„ì— ìˆ˜ë™ ì…ë ¥ëœ ì—°ì´ˆìì‚°(override)ì´ ì—†ì„ ë•Œë§Œ ìºìŠ¤ì¼€ì´ë“œ ì§„í–‰
              if (yearDataStore[nextYear]?.beginningAssets === undefined) {
                const nextBegValue = calculateYearEndAssets(newItems[i]);
                if (newItems[i + 1].beginningAssets !== nextBegValue) {
                  newItems[i + 1] = { ...newItems[i + 1], beginningAssets: nextBegValue };
                } else {
                  break; // ê°’ì´ ë™ì¼í•˜ë©´ ì´í›„ëŠ” ë³€í™”ê°€ ì—†ìœ¼ë¯€ë¡œ ì¤‘ë‹¨
                }
              } else {
                break; // ìˆ˜ë™ ì…ë ¥ê°’ì„ ë§Œë‚˜ë©´ ì¤‘ë‹¨
              }
            }
          }
          return newItems;
        });
      };



      const compressImage = (file) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const MAX_WIDTH = 1000; // ê°€ë¡œ ìµœëŒ€ 1000px
              const MAX_HEIGHT = 1000; // ì„¸ë¡œ ìµœëŒ€ 1000px
              let width = img.width;
              let height = img.height;

              if (width > height) {
                if (width > MAX_WIDTH) {
                  height *= MAX_WIDTH / width;
                  width = MAX_WIDTH;
                }
              } else {
                if (height > MAX_HEIGHT) {
                  width *= MAX_HEIGHT / height;
                  height = MAX_HEIGHT;
                }
              }

              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);

              // 0.7 í€„ë¦¬í‹°ì˜ JPEGë¡œ ì••ì¶• (ìš©ëŸ‰ ëŒ€í­ ê°ì†Œ)
              const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
              resolve(dataUrl);
            };
            img.onerror = reject;
          };
          reader.onerror = reject;
        });
      };

      const handleImageUpload = async (e) => {
        const file = e.target.files[0];
        if (file && activeCell !== null) {
          try {
            // ì´ë¯¸ì§€ ì••ì¶• ì¤‘ ìƒíƒœ í‘œì‹œ
            setModalState({ type: 'status', data: { title: "ì´ë¯¸ì§€ ì••ì¶• ì¤‘", msg: "ì´ë¯¸ì§€ë¥¼ ìµœì í™”í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...", icon: "loader", animate: true } });

            const compressed = await compressImage(file);
            updateDynamicData(activeCell.index, activeCell.rowId, compressed);
            closeModal(); // ì™„ë£Œ í›„ ëª¨ë‹¬ ë‹«ê¸° (setModalState(null) ì‚¬ìš© ì‹œ ë Œë”ë§ ì—ëŸ¬ ë°œìƒ ê°€ëŠ¥í•˜ì—¬ ìˆ˜ì •)
          } catch (error) {
            console.error("Image processing error:", error);
            setModalState({ type: 'status', data: { title: "ì²˜ë¦¬ ì˜¤ë¥˜", msg: "ì´ë¯¸ì§€ ì••ì¶• ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", icon: "alert-triangle" } });
          } finally {
            setActiveCell(null);
          }
        }
        e.target.value = null;
      };

      const triggerFileInput = (index, rowId) => {
        setActiveCell({ index, rowId });
        fileInputRef.current?.click();
      };

      const removeImage = (e, index, rowId) => {
        e.stopPropagation();
        updateDynamicData(index, rowId, "");
      };

      const moveRow = (id, direction) => {
        const index = allRows.findIndex(r => r.id === id);
        if ((direction === 'up' && index === 0) || (direction === 'down' && index === allRows.length - 1)) return;

        const newRows = [...allRows];
        const swapIndex = direction === 'up' ? index - 1 : index + 1;
        [newRows[index], newRows[swapIndex]] = [newRows[swapIndex], newRows[index]];
        setAllRows(newRows);
      };

      const updateRowLabel = (id, newLabel) => {
        setAllRows(prev => prev.map(r => r.id === id ? { ...r, label: newLabel } : r));
      };

      const deleteRow = (id) => {
        const isSystem = ['beginningAssets', 'investedAssets', 'targetReturn', 'savings', 'yearEndAssets'].includes(id);
        const msg = isSystem
          ? 'ì´ í–‰ì€ ê°€ê³„ì‚° ë¡œì§ì´ í¬í•¨ëœ ê¸°ë³¸ í–‰ì…ë‹ˆë‹¤.\nì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'
          : 'ì„ íƒí•œ í–‰ì„ ë¡œë“œë§µì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?';

        setModalState({ type: 'confirmDelete', data: { id, msg, isSystem } });
      };

      const executeDelete = () => {
        if (modalState.data?.id) {
          setAllRows(prev => prev.filter(r => r.id !== modalState.data.id));
          closeModal();
        }
      };

      const onDragStart = (e, index) => {
        setDraggedRowIndex(index);
        e.dataTransfer.effectAllowed = 'move';
      };

      const onDragOver = (e) => {
        e.preventDefault();
      };

      const onDrop = (e, index) => {
        e.preventDefault();
        if (draggedRowIndex === null || draggedRowIndex === index) return;

        const newRows = [...allRows];
        const item = newRows.splice(draggedRowIndex, 1)[0];
        newRows.splice(index, 0, item);

        setAllRows(newRows);
        setDraggedRowIndex(null);
      };



      const handleAutoHeight = (e) => {
        e.target.style.height = 'auto';
        e.target.style.height = `${e.target.scrollHeight}px`;
      };

      const downloadImage = async () => {
        const container = roadmapRef.current;
        if (!container) return;

        if (!window.html2canvas) {
          const script = document.createElement('script');
          script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
          script.onload = () => executeDownloadSplit(container);
          document.head.appendChild(script);
        } else {
          executeDownloadSplit(container);
        }
      };

      const executeDownloadSplit = async (container) => {
        // 1. í—¤ë” ì˜ì—­ (ì œëª©, ìƒë‹¨ ì •ë³´, ëª©í‘œ) ìº¡ì²˜ ì¤€ë¹„
        // 2. 10ë…„ ë‹¨ìœ„ í…Œì´ë¸” ë¸”ë¡ë“¤ì„ ì°¾ìŒ
        const tables = container.querySelectorAll('.mb-8.md\\:mb-12.overflow-hidden.rounded-\\[1\\.5rem\\]');
        if (tables.length === 0) return;

        setModalState({ type: 'status', data: { title: "ì´ë¯¸ì§€ ìƒì„± ì¤‘", msg: "3ê°œì˜ í…Œì´ë¸” ë¸”ë¡ì„ ê°œë³„ ì´ë¯¸ì§€ë¡œ ì €ì¥í•©ë‹ˆë‹¤...", icon: "loader", animate: true } });

        // ì²« ë²ˆì§¸ ì´ë¯¸ì§€ì—ëŠ” ìƒë‹¨ ì •ë³´(í—¤ë”+ëª©í‘œ)ë¥¼ í¬í•¨í• ì§€ ì—¬ë¶€ ê²°ì •
        // ì—¬ê¸°ì„œëŠ” ê° í…Œì´ë¸” ë¸”ë¡ë§Œ ê¹”ë”í•˜ê²Œ ì €ì¥í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„
        for (let i = 0; i < tables.length; i++) {
          const tableBlock = tables[i];
          const yearText = tableBlock.querySelector('h2')?.textContent?.trim() || `Part_${i + 1}`;
          const safeFileName = yearText.replace(/[^a-z0-9ê°€-í£_\-~ ]/gi, '_');

          await html2canvas(tableBlock, {
            scale: 3,
            useCORS: true,
            backgroundColor: darkMode ? '#0f172a' : '#ffffff',
            logging: false,
            onclone: (clonedDoc) => {
              // ìº¡ì²˜ìš© ìŠ¤íƒ€ì¼ ë³´ì • (Input -> Div ë³€í™˜ ë“±)
              const clonedBlock = clonedDoc.body.querySelector('.mb-8.md\\:mb-12.overflow-hidden.rounded-\\[1\\.5rem\\]'); // ì˜ˆì‹œ ì„ íƒì
              // ì‹¤ì œë¡œëŠ” html2canvasê°€ ë„˜ê²¨ë°›ì€ blockì„ ê¸°ì¤€ìœ¼ë¡œ ë Œë”ë§í•˜ë¯€ë¡œ 
              // onclone ë‚´ë¶€ì—ì„œ clonedDocì„ í†µí•´ í•´ë‹¹ ìš”ì†Œì˜ í•˜ìœ„ ì—˜ë¦¬ë¨¼íŠ¸ë“¤ì„ ì „ì—­ì ìœ¼ë¡œ ìˆ˜ì • ê°€ëŠ¥

              const inputs = clonedDoc.querySelectorAll('input, textarea');
              inputs.forEach(input => {
                const parent = input.parentElement;
                if (parent) {
                  const displayDiv = clonedDoc.createElement('div');
                  displayDiv.textContent = input.value;
                  displayDiv.className = input.className;
                  displayDiv.style.cssText = window.getComputedStyle(input).cssText;
                  displayDiv.style.display = 'block';
                  displayDiv.style.whiteSpace = 'pre-wrap';
                  displayDiv.style.wordBreak = 'break-all';
                  displayDiv.style.textAlign = input.classList.contains('text-right') ? 'right' : 'center';
                  input.style.display = 'none';
                  parent.appendChild(displayDiv);
                }
              });

              const tbls = clonedDoc.querySelectorAll('table');
              tbls.forEach(t => {
                t.style.width = '100%';
                t.style.minWidth = '0';
                t.style.tableLayout = 'fixed';
              });
            }
          }).then(canvas => {
            const link = document.createElement('a');
            link.download = `ì¸ìƒë¡œë“œë§µ_${safeFileName}.png`;
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
          });

          // ë‹¤ìš´ë¡œë“œ ì‚¬ì´ ê°„ê²©
          await new Promise(resolve => setTimeout(resolve, 500));
        }

        setModalState({ type: 'status', data: { title: "ì €ì¥ ì™„ë£Œ", msg: "3ê°œì˜ ì¡°ê° ì´ë¯¸ì§€ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.", icon: "check-circle" } });
      };

      const downloadExcel = async () => {
        try {
          const Excel = window.ExcelJS || (typeof ExcelJS !== 'undefined' ? ExcelJS : null);
          if (!Excel) {
            setModalState({ type: 'status', data: { title: "ì˜¤ë¥˜ ë°œìƒ", msg: "ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.", icon: "alert-circle" } });
            return;
          }

          setModalState({ type: 'status', data: { title: "íŒŒì¼ ìƒì„± ì¤‘", msg: "ì—‘ì…€ íŒŒì¼ ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì´ë¯¸ì§€ê°€ ë§ì„ ê²½ìš° ìˆ˜ ì´ˆ ì •ë„ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.", icon: "loader", animate: true } });

          const workbook = new Excel.Workbook();
          const worksheet = workbook.addWorksheet('ì¸ìƒ ë¡œë“œë§µ');

          // ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì„¤ì •
          worksheet.properties.defaultRowHeight = 25;

          // 1. ë¬¸ì„œ ìš”ì•½ ì •ë³´ (ìµœìƒë‹¨)
          const titleRow = worksheet.addRow([pageTitle]);
          titleRow.font = { size: 18, bold: true, color: { argb: 'FFAF1D42' } };

          const subTitleRow = worksheet.addRow([pageSubtitle]);
          subTitleRow.font = { size: 12, italic: true };

          worksheet.addRow([]);
          worksheet.addRow(['[ë‚˜ì˜ ëª©í‘œ]', goalTitle]).font = { bold: true };
          worksheet.addRow(['[ë‚˜ì˜ ëª…ì–¸]', goalQuote]).font = { italic: true };
          worksheet.addRow([]);
          worksheet.addRow(['[ê¸°ì¤€ ì •ë³´]', `ì‹œì‘ ì—°ë„: ${startYear}ë…„ / ì‹œì‘ ë‚˜ì´: ${startAge}ì„¸ / í™”í ë‹¨ìœ„: ${savingsUnit}`]);
          worksheet.addRow(['* ì°¸ê³ : 30ë…„ ì¸ìƒ ì‹œë‚˜ë¦¬ì˜¤ê°€ 10ë…„ ë‹¨ìœ„ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.']);
          worksheet.addRow([]);

          // 2. ë©”ì¸ ë°ì´í„° í…Œì´ë¸” êµ¬ì„± (10ë…„ì”© 3ë‹¨ê³„ë¡œ ë¶„í• )
          for (const blockStartIndex of [0, 10, 20]) {
            const chunk = items.slice(blockStartIndex, blockStartIndex + 10);

            // ê° ë¸”ë¡ì˜ í—¤ë”
            const headerValues = ['êµ¬ë¶„', ...chunk.map((_, i) => `${startYear + blockStartIndex + i}ë…„ (${startAge + blockStartIndex + i}ì„¸)`)];
            const headerRow = worksheet.addRow(headerValues);

            headerRow.eachCell((cell) => {
              cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFAF1D42' } };
              cell.font = { color: { argb: 'FFFFFFFF' }, bold: true };
              cell.alignment = { horizontal: 'center', vertical: 'middle' };
              cell.border = {
                top: { style: 'thin', color: { argb: 'FFEBEDF0' } },
                left: { style: 'thin', color: { argb: 'FFEBEDF0' } },
                bottom: { style: 'thin', color: { argb: 'FFEBEDF0' } },
                right: { style: 'thin', color: { argb: 'FFEBEDF0' } }
              };
            });

            // í–‰ë³„ ë°ì´í„° êµ¬ì„±
            for (const rowDef of allRows) {
              const rowValues = [rowDef.label];
              const isImageRow = rowDef.type === 'image';

              chunk.forEach((item) => {
                if (rowDef.id === 'yearEndAssets') {
                  rowValues.push(calculateYearEndAssets(item));
                } else if (rowDef.id === 'targetReturn') {
                  rowValues.push(`${item.targetReturn}%`);
                } else if (rowDef.isSystem) {
                  rowValues.push(item[rowDef.id] || 0);
                } else if (isImageRow) {
                  rowValues.push(""); // ì´ë¯¸ì§€ê°€ ë“¤ì–´ê°ˆ ìë¦¬ëŠ” ë¹„ì›Œë‘ 
                } else {
                  rowValues.push(item.dynamicData?.[rowDef.id] || '');
                }
              });

              const newRow = worksheet.addRow(rowValues);

              // í–‰ ìŠ¤íƒ€ì¼ ë° ì´ë¯¸ì§€ ì‚½ì…
              newRow.eachCell((cell, colNumber) => {
                cell.alignment = { vertical: 'middle', horizontal: colNumber === 1 ? 'center' : 'right', wrapText: true };
                cell.border = {
                  top: { style: 'thin', color: { argb: 'FFEBEDF0' } },
                  left: { style: 'thin', color: { argb: 'FFEBEDF0' } },
                  bottom: { style: 'thin', color: { argb: 'FFEBEDF0' } },
                  right: { style: 'thin', color: { argb: 'FFEBEDF0' } }
                };
                if (colNumber === 1) cell.font = { bold: true };
              });

              if (isImageRow) {
                newRow.height = 120; // ì´ë¯¸ì§€ í–‰ ë†’ì´ í¬ê²Œ ì„¤ì •
                chunk.forEach((item, chunkIdx) => {
                  const imgData = item.dynamicData?.[rowDef.id];
                  if (imgData && imgData.includes('base64,')) {
                    try {
                      const base64Content = imgData.split('base64,')[1];
                      const imageId = workbook.addImage({
                        base64: base64Content,
                        extension: 'png',
                      });
                      worksheet.addImage(imageId, {
                        tl: { col: chunkIdx + 1, row: newRow.number - 1 },
                        br: { col: chunkIdx + 2, row: newRow.number },
                        editAs: 'oneCell'
                      });
                    } catch (e) {
                      console.error("ì´ë¯¸ì§€ ì‚½ì… ì‹¤íŒ¨", e);
                    }
                  }
                });
              }
            }

            // ë¸”ë¡ ì‚¬ì´ ê°„ê²©
            worksheet.addRow([]);
            worksheet.addRow([]);
          }

          // ì „ì²´ ì—´ ë„ˆë¹„ ì„¤ì •
          worksheet.columns.forEach((col, i) => {
            col.width = i === 0 ? 25 : 18;
            if (i > 0) {
              col.alignment = { horizontal: 'center', vertical: 'middle' };
            }
          });

          // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          const buffer = await workbook.xlsx.writeBuffer();
          const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `ì¸ìƒ_ë¡œë“œë§µ_30ë…„_ì´ë¯¸ì§€í¬í•¨.xlsx`;
          link.click();
          window.URL.revokeObjectURL(url);
          setModalState({ type: 'status', data: { title: "ì €ì¥ ì™„ë£Œ", msg: "ì´ë¯¸ì§€ê°€ í¬í•¨ëœ ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!", icon: "check-circle" } });
        } catch (error) {
          console.error("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:", error);
          setModalState({ type: 'status', data: { title: "ì˜¤ë¥˜ ë°œìƒ", msg: `ì—‘ì…€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, icon: "alert-triangle" } });
        }
      };

      const scrollTable = (idx, amount) => {
        const container = document.getElementById(`table-container-${idx}`);
        if (container) {
          container.scrollBy({ left: amount, behavior: 'smooth' });
        }
      };

      const renderTable = (startIndex) => {
        const chunk = items.slice(startIndex, startIndex + 10);
        const borderColor = darkMode ? 'border-slate-700' : 'border-slate-300';
        const headerBg = darkMode ? 'bg-brand-800' : 'bg-brand-600';
        const rowHeaderBg = darkMode ? 'bg-slate-800/80' : 'bg-slate-50';

        return (
          <div key={startIndex} className={`mb-8 md:mb-12 overflow-hidden rounded-[1.5rem] md:rounded-[2.5rem] shadow-sm border ${borderColor} p-4 md:p-6 ${darkMode ? 'bg-slate-900 shadow-brand-950/20' : 'bg-white'} transition-all`}>
            <div className="flex items-center justify-between mb-4 md:mb-6 px-2">
              <h2 className={`text-xl md:text-3xl font-black flex items-center gap-4 ${darkMode ? 'text-brand-300' : 'text-brand-700'} tracking-tighter`}>
                <span className="text-3xl md:text-4xl drop-shadow-md">ğŸ‘‘</span>
                {startYear + startIndex}ë…„ ~ {startYear + startIndex + 9}ë…„
              </h2>
              <div className="md:hidden text-[10px] bg-brand-500/10 text-brand-600 px-3 py-1 rounded-full font-bold animate-pulse">
                ì˜†ìœ¼ë¡œ ìŠ¬ë¼ì´ë“œ â†’
              </div>
            </div>
            <div id={`table-container-${startIndex}`} className="overflow-x-auto scrollbar-hide pb-2">
              <table className={`w-full border-collapse border border-slate-200 dark:border-brand-900/30 text-[11px] table-fixed min-w-[1400px]`}>
                <thead>
                  <tr className={`${headerBg} text-white shadow-lg relative`}>
                    <th className={`border border-white/10 p-4 w-44 text-sm font-black uppercase tracking-tighter relative group/header`}>
                      êµ¬ë¶„
                      <div
                        onMouseDown={startResizing}
                        className="absolute bottom-0 left-0 w-full h-1.5 cursor-row-resize bg-white/20 hover:bg-white/40 opacity-0 group-hover/header:opacity-100 transition-opacity z-10"
                        title="ë“œë˜ê·¸í•˜ì—¬ í–‰ ë†’ì´ ì¡°ì ˆ"
                      ></div>
                    </th>
                    {chunk.map((_, i) => (
                      <th key={i} className={`border border-white/10 p-2 text-center`}>
                        <div className="text-xl font-black">{startYear + startIndex + i}ë…„</div>
                        <div className="text-xs opacity-80 font-bold uppercase">{startAge + startIndex + i}ì„¸</div>
                      </th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {allRows.map((row, rowIndex) => {
                    const isYearEnd = row.id === 'yearEndAssets';
                    const rowBg = isYearEnd ? (darkMode ? 'bg-brand-900/40' : 'bg-brand-50') : 'transition-colors hover:bg-slate-500/5';
                    const textColor = isYearEnd ? (darkMode ? 'text-brand-300' : 'text-brand-700 font-black') : 'text-slate-700 dark:text-slate-200';

                    return (
                      <tr
                        key={row.id}
                        draggable
                        onDragStart={(e) => onDragStart(e, rowIndex)}
                        onDragOver={onDragOver}
                        onDrop={(e) => onDrop(e, rowIndex)}
                        className={`${rowBg} cursor-move`}
                        style={{ height: `${row.isSystem ? Math.max(40, globalRowHeight * 0.5) : globalRowHeight}px` }}
                      >
                        <td className={`${rowHeaderBg} border ${borderColor} p-3 font-black text-center text-sm relative group align-middle overflow-hidden`}>
                          <div className={`flex flex-col items-center justify-center gap-2 h-full relative`}>
                            <div className="absolute left-0 top-1/2 -translate-y-1/2 text-slate-300 opacity-20 group-hover:opacity-100 transition-opacity pointer-events-none">
                              <Icon name="grip-vertical" size={16} />
                            </div>

                            <button
                              onClick={(e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                deleteRow(row.id);
                              }}
                              className="absolute right-1 top-1 p-1.5 bg-red-500/10 text-red-500/40 hover:text-red-600 hover:bg-red-500/20 opacity-100 transition-all z-20 cursor-pointer rounded-lg"
                              title="í–‰ ì‚­ì œ"
                            >
                              <Icon name="trash-2" size={16} />
                            </button>

                            <div className="flex items-center justify-center gap-2">
                              {row.operator === 'add' && <span className="bg-emerald-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px] shadow-sm">+</span>}
                              {row.operator === 'subtract' && <span className="bg-red-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px] shadow-sm">-</span>}
                              <input
                                value={row.label}
                                onChange={(e) => updateRowLabel(row.id, e.target.value)}
                                onClick={(e) => e.stopPropagation()}
                                spellCheck="false"
                                className="w-full bg-transparent text-center outline-none border-b border-transparent focus:border-brand-500 transition-all pb-1 break-all leading-tight cursor-text text-slate-800 dark:text-slate-100 z-10"
                              />
                            </div>
                          </div>
                        </td>
                        {chunk.map((item, i) => {
                          const globalIdx = startIndex + i;
                          let content;

                          if (row.id === 'yearEndAssets') {
                            content = (
                              <div className="p-2 text-right font-black text-[15px]">
                                {calculateYearEndAssets(item).toLocaleString()}
                              </div>
                            );
                          } else if (row.type === 'number' || row.id === 'beginningAssets' || row.id === 'investedAssets' || row.id === 'savings') {
                            const val = row.isSystem ? item[row.id] : item.dynamicData?.[row.id];
                            content = (
                              <input
                                type="text"
                                value={row.isSystem ? (Number(val) === 0 ? "" : Number(val).toLocaleString()) : (item.dynamicData?.[row.id] || "")}
                                onChange={(e) => {
                                  const cleaned = e.target.value.replace(/,/g, '').replace(/[^0-9.\-]/g, '');
                                  row.isSystem
                                    ? updateItem(globalIdx, row.id, cleaned)
                                    : updateDynamicData(globalIdx, row.id, cleaned);
                                }}
                                spellCheck="false"
                                className={`w-full text-right p-1 bg-transparent pr-3 outline-none font-black text-[15px] ${row.id === 'investedAssets' ? 'text-brand-600 dark:text-brand-400' :
                                  row.id === 'savings' ? 'text-orange-500 dark:text-orange-400' :
                                    row.operator === 'add' ? 'text-emerald-600 dark:text-emerald-400' :
                                      row.operator === 'subtract' ? 'text-red-500 dark:text-red-400' :
                                        'text-slate-700 dark:text-white'
                                  }`}
                              />
                            );
                          } else if (row.id === 'targetReturn') {
                            content = (
                              <div className="flex items-center justify-end w-full px-2 group/input">
                                <input
                                  type="text"
                                  value={item.targetReturn}
                                  onChange={(e) => {
                                    const cleaned = e.target.value.replace(/[^0-9.]/g, '');
                                    updateItem(globalIdx, 'targetReturn', cleaned);
                                  }}
                                  spellCheck="false"
                                  className="w-12 text-right p-1 font-black bg-transparent outline-none text-emerald-500 dark:text-emerald-400 text-[15px]"
                                />
                                <span className="text-emerald-500 dark:text-emerald-400 font-extrabold text-[15px] leading-none">%</span>
                              </div>
                            );
                          } else if (row.type === 'image') {
                            const cellData = item.dynamicData?.[row.id];
                            content = (
                              <div
                                onClick={() => cellData ? setModalState({ type: 'previewImage', data: cellData }) : triggerFileInput(globalIdx, row.id)}
                                className={`w-full min-h-[90px] relative group border-2 border-dashed rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-all overflow-hidden ${cellData ? 'border-transparent' : (darkMode ? 'border-slate-700 hover:border-slate-500 bg-slate-900 shadow-inner' : 'border-slate-200 hover:border-slate-300 bg-slate-50')}`}
                              >
                                {cellData ? (
                                  <>
                                    <img src={cellData} className="w-full h-full object-cover transition-transform group-hover:scale-105" />
                                    <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center gap-2">
                                      <div className="bg-white/20 backdrop-blur-md px-4 py-2 rounded-full text-white text-[10px] font-black border border-white/30">í´ë¦­ í™•ëŒ€</div>
                                      <button onClick={(e) => { e.stopPropagation(); removeImage(e, globalIdx, row.id); }} className="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg flex items-center gap-2 text-[10px] font-black mt-2">ì‚­ì œ</button>
                                    </div>
                                  </>
                                ) : (
                                  <><Icon name="plus" size={24} className="text-slate-300 mb-1" /><span className="text-[10px] font-bold text-slate-400">ì´ë¯¸ì§€ ì¶”ê°€</span></>
                                )}
                              </div>
                            );
                          } else {
                            const cellData = item.dynamicData?.[row.id] || "";
                            content = (
                              <textarea
                                value={cellData}
                                onChange={(e) => { updateDynamicData(globalIdx, row.id, e.target.value); handleAutoHeight(e); }}
                                placeholder="ì…ë ¥..."
                                spellCheck="false"
                                className="w-full min-h-[100px] p-3 text-[12px] bg-transparent resize-none outline-none overflow-hidden font-medium leading-relaxed scrollbar-hide focus:bg-brand-500/5 dark:focus:bg-brand-500/10 rounded-xl transition-all text-slate-700 dark:text-white"
                              />
                            );
                          }

                          return (
                            <td key={i} className={`border ${borderColor} p-1 align-middle`}>
                              {content}
                            </td>
                          );
                        })}
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>

            {/* ì‹œì  ì´ë™ ìŠ¬ë¼ì´ë“œ ë²„íŠ¼ (í…Œì´ë¸”ì´ ë„“ì–´ì„œ 1500px ë¯¸ë§Œ ì‹œ ë…¸ì¶œ) */}
            <div className="flex items-center justify-center gap-8 mt-6 2xl:hidden">
              <button
                onClick={() => scrollTable(startIndex, -400)}
                className="w-16 h-16 rounded-full bg-white dark:bg-slate-800 shadow-xl border border-slate-100 dark:border-slate-700 flex items-center justify-center text-brand-600 active:scale-90 transition-all hover:bg-brand-50 dark:hover:bg-slate-700"
              >
                <Icon name="chevron-left" size={32} />
              </button>
              <div className="flex flex-col items-center">
                <span className="text-[10px] font-black text-brand-500 uppercase tracking-widest mb-1 select-none">Slide</span>
                <div className="flex gap-1.5">
                  <div className={`w-2 h-2 rounded-full transition-all ${startIndex === 0 ? 'bg-brand-600 scale-125' : 'bg-slate-300'}`}></div>
                  <div className={`w-2 h-2 rounded-full transition-all ${startIndex === 10 ? 'bg-brand-600 scale-125' : 'bg-slate-300'}`}></div>
                  <div className={`w-2 h-2 rounded-full transition-all ${startIndex === 20 ? 'bg-brand-600 scale-125' : 'bg-slate-300'}`}></div>
                </div>
              </div>
              <button
                onClick={() => scrollTable(startIndex, 400)}
                className="w-16 h-16 rounded-full bg-white dark:bg-slate-800 shadow-xl border border-slate-100 dark:border-slate-700 flex items-center justify-center text-brand-600 active:scale-90 transition-all hover:bg-brand-50 dark:hover:bg-slate-700"
              >
                <Icon name="chevron-right" size={32} />
              </button>
            </div>
          </div>
        );
      };

      if (isAuthChecking) {
        return (
          <div className="min-h-screen bg-brand-600 flex flex-col items-center justify-center gap-6 animate-pulse">
            <Icon name="loader" className="text-white animate-spin" size={60} />
            <p className="text-white text-xl font-bold tracking-widest opacity-90">ë°ì´í„° ë™ê¸°í™” ì¤‘...</p>
          </div>
        );
      }

      if (!currentUser) {
        return (
          <div className="min-h-screen bg-brand-600 flex flex-col items-center justify-center p-6 text-white text-center animate-in">
            <div className="w-full max-w-md space-y-10">
              <div className="space-y-4">
                <div className="w-24 h-24 bg-white/20 rounded-3xl mx-auto flex items-center justify-center backdrop-blur-sm mb-8 shadow-2xl">
                  <Icon name="map" size={48} className="text-white" />
                </div>
                <h1 className="text-4xl md:text-5xl font-black tracking-tighter drop-shadow-lg leading-tight">
                  ë‹¹ì‹ ì˜ 30ë…„<br /> <span className="text-brand-200">ì¸ìƒ ë¡œë“œë§µ</span>
                </h1>
                <p className="text-lg md:text-xl font-bold opacity-90 leading-relaxed break-keep">
                  ë¯¸ë˜ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ê³„íší•˜ê³  ì‹¤í˜„í•˜ì„¸ìš”. <br />
                  <span className="text-sm font-medium opacity-70 mt-4 block">
                    "ë‹¹ì‹ ì˜ 30ë…„ ì¸ìƒ ë¡œë“œë§µìœ¼ë¡œ ë“¤ì–´ê°€ë³´ì‹œê² ìŠµë‹ˆê¹Œ?"
                  </span>
                </p>
              </div>

              <div className="space-y-4 pt-8">
                <button
                  onClick={handleLogin}
                  className="w-full py-5 bg-white text-brand-600 rounded-2xl font-black text-xl shadow-[0_20px_40px_-10px_rgba(0,0,0,0.3)] hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-3"
                >
                  <Icon name="log-in" size={24} />
                  <span>êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°</span>
                </button>
                <p className="text-xs font-medium opacity-60">
                  * ì•ˆì „í•œ Google ë¡œê·¸ì¸ìœ¼ë¡œ ë°ì´í„°ê°€ ë™ê¸°í™”ë©ë‹ˆë‹¤.
                </p>
              </div>
            </div>
            {/* ë°°ê²½ ì¥ì‹ ìš”ì†Œ */}
            <div className="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none opacity-20">
              <div className="absolute -top-[20%] -left-[10%] w-[60vw] h-[60vw] bg-brand-400 rounded-full blur-[120px] mix-blend-screen animate-pulse-slow"></div>
              <div className="absolute top-[40%] -right-[10%] w-[50vw] h-[50vw] bg-brand-500 rounded-full blur-[100px] mix-blend-screen animate-pulse-slow" style={{ animationDelay: '1s' }}></div>
              <div className="absolute -bottom-[20%] left-[20%] w-[70vw] h-[70vw] bg-brand-800 rounded-full blur-[140px] mix-blend-overlay"></div>
            </div>
            {/* ëª¨ë‹¬: ìƒíƒœ ì•Œë¦¼ (ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‹œ ë“±) */}
            <Modal
              isOpen={modalState?.type === 'status'}
              onClose={closeModal}
              title={modalState?.data?.title || "ì•Œë¦¼"}
            >
              <div className="space-y-6 text-center py-6 text-slate-800">
                <div className={`w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 ${modalState?.data?.icon === 'check-circle' ? 'bg-emerald-100 text-emerald-500' :
                  modalState?.data?.icon === 'alert-triangle' || modalState?.data?.icon === 'alert-circle' ? 'bg-red-100 text-red-500' :
                    'bg-brand-100 text-brand-500'
                  }`}>
                  <Icon name={modalState?.data?.icon || "info"} size={40} className={modalState?.data?.animate ? "animate-spin" : ""} />
                </div>
                <p className="font-bold text-lg whitespace-pre-wrap leading-relaxed">
                  {modalState?.data?.msg}
                </p>
                <button
                  onClick={closeModal}
                  className="w-full py-4 bg-brand-600 hover:bg-brand-700 text-white rounded-2xl font-black text-lg shadow-xl transition-all"
                >
                  í™•ì¸
                </button>
              </div>
            </Modal>
          </div>
        );
      }

      return (
        <div className={`min-h-screen transition-all ${darkMode ? 'dark bg-slate-950 text-slate-100' : 'bg-slate-50 text-slate-900'}`} style={{ fontFamily: 'NanumSquare, sans-serif' }}>
          <input type="file" ref={fileInputRef} onChange={handleImageUpload} accept="image/*" className="hidden" />

          {/* ëª¨ë‹¬: ì œëª© í¸ì§‘ */}
          <Modal
            isOpen={modalState?.type === 'header'}
            onClose={closeModal}
            title="ë¬¸ì„œ ì œëª© ë° ì•ˆë‚´ ìˆ˜ì •"
          >
            <div className="space-y-6">
              <div>
                <label className="block text-xs font-black uppercase tracking-widest text-slate-400 dark:text-slate-500 mb-2">ë©”ì¸ ì œëª©</label>
                <input
                  type="text"
                  className="w-full p-4 rounded-2xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900 font-black text-lg outline-none focus:ring-2 focus:ring-brand-500 text-slate-800 dark:text-slate-100"
                  value={pageTitle}
                  onChange={e => setPageTitle(e.target.value)}
                />
              </div>
              <div>
                <label className="block text-xs font-black uppercase tracking-widest text-slate-400 dark:text-slate-500 mb-2">ì„œë¸Œ ì•ˆë‚´ ë¬¸êµ¬</label>
                <textarea
                  className="w-full p-4 rounded-2xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900 font-bold outline-none focus:ring-2 focus:ring-brand-500 min-h-[100px] text-slate-700 dark:text-slate-200"
                  value={pageSubtitle}
                  onChange={e => { setPageSubtitle(e.target.value); handleAutoHeight(e); }}
                />
              </div>
              <button onClick={closeModal} className="w-full py-4 bg-brand text-white rounded-2xl font-black text-lg shadow-xl shadow-brand/20 hover:scale-[1.02] transition-transform">ì €ì¥í•˜ê¸°</button>
            </div>
          </Modal>

          {/* ëª¨ë‹¬: í–‰ ì¶”ê°€/ìˆ˜ì • */}
          <Modal
            isOpen={modalState?.type === 'addRow' || modalState?.type === 'editRow'}
            onClose={closeModal}
            title={modalState?.type === 'addRow' ? 'ìƒˆë¡œìš´ í–‰ ì¶”ê°€' : 'í–‰ ì •ë³´ ìˆ˜ì •'}
          >
            <div className="space-y-6">
              <div>
                <label className="block text-xs font-black uppercase tracking-widest text-slate-400 dark:text-slate-500 mb-2">í–‰ ì´ë¦„ (ë¼ë²¨)</label>
                <input
                  id="row-label-input"
                  type="text"
                  spellCheck="false"
                  className="w-full p-4 rounded-2xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900 font-black text-lg outline-none focus:ring-2 focus:ring-brand-500 text-slate-800 dark:text-slate-100"
                  defaultValue={modalState?.data?.label || ''}
                  placeholder="ì˜ˆ: ë¼ì´í”„ í”Œëœ, ìê¸° ê°œë°œ"
                />
              </div>

              <div>
                <label className="block text-xs font-black uppercase tracking-widest text-slate-400 dark:text-slate-500 mb-2">ë°ì´í„° íƒ€ì…</label>
                <div className="grid grid-cols-3 gap-3">
                  <button id="type-text" onClick={(e) => {
                    document.getElementById('type-text').classList.add('bg-brand-600', 'text-white', 'border-brand-600');
                    document.getElementById('type-number').classList.remove('bg-brand-600', 'text-white', 'border-brand-600');
                    document.getElementById('type-image').classList.remove('bg-brand-600', 'text-white', 'border-brand-600');
                    window._selectedType = 'textarea';
                    document.getElementById('operator-section').classList.add('hidden');
                  }} className={`py-4 rounded-2xl border font-black transition-all ${(!modalState?.data || modalState?.data?.type === 'textarea') ? 'bg-brand-600 text-white border-brand-600' : 'border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300'}`}>í…ìŠ¤íŠ¸</button>
                  <button id="type-number" onClick={(e) => {
                    document.getElementById('type-number').classList.add('bg-brand-600', 'text-white', 'border-brand-600');
                    document.getElementById('type-text').classList.remove('bg-brand-600', 'text-white', 'border-brand-600');
                    document.getElementById('type-image').classList.remove('bg-brand-600', 'text-white', 'border-brand-600');
                    window._selectedType = 'number';
                    document.getElementById('operator-section').classList.remove('hidden');
                  }} className={`py-4 rounded-2xl border font-black transition-all ${(modalState?.data?.type === 'number') ? 'bg-brand-600 text-white border-brand-600' : 'border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300'}`}>ìˆ«ì</button>
                  <button id="type-image" onClick={(e) => {
                    document.getElementById('type-image').classList.add('bg-brand-600', 'text-white', 'border-brand-600');
                    document.getElementById('type-text').classList.remove('bg-brand-600', 'text-white', 'border-brand-600');
                    document.getElementById('type-number').classList.remove('bg-brand-600', 'text-white', 'border-brand-600');
                    window._selectedType = 'image';
                    document.getElementById('operator-section').classList.add('hidden');
                  }} className={`py-4 rounded-2xl border font-black transition-all ${(modalState?.data?.type === 'image') ? 'bg-brand-600 text-white border-brand-600' : 'border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300'}`}>ì´ë¯¸ì§€</button>
                </div>

                <div id="operator-section" className={modalState?.data?.type === 'number' || window._selectedType === 'number' ? "" : "hidden"}>
                  <label className="block text-xs font-black uppercase tracking-widest text-slate-400 dark:text-slate-500 mb-2 mt-4">ë°ì´í„° ì—°ì‚° (ì—°ë§ìì‚° ë°˜ì˜)</label>
                  <select id="row-operator-select" defaultValue={modalState?.data?.operator || ""} className="w-full p-4 rounded-2xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900 font-black text-lg outline-none focus:ring-2 focus:ring-brand-500 text-slate-800 dark:text-slate-100 mb-4">
                    <option value="">ì—°ì‚° ì—†ìŒ (ê·¸ëƒ¥ ê¸°ë¡)</option>
                    <option value="add">ìì‚°ì— í•©ì‚° (+)</option>
                    <option value="subtract">ìì‚°ì—ì„œ ì°¨ê° (-)</option>
                  </select>
                </div>
              </div>
              <button
                onClick={() => {
                  const label = document.getElementById('row-label-input').value;
                  if (!label) return alert('í–‰ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                  const type = window._selectedType || 'textarea';
                  const operator = document.getElementById('row-operator-select')?.value || "";

                  if (modalState?.type === 'addRow') {
                    addRow(label, type, operator);
                  } else {
                    updateRowInfo(modalState?.data?.id, label, type, operator);
                  }
                  closeModal();
                }}
                className="w-full py-5 bg-brand-600 text-white rounded-2xl font-black text-xl shadow-xl hover:scale-[1.02] active:scale-95 transition-all"
              >
                {modalState?.type === 'addRow' ? 'ìƒì„±í•˜ê¸°' : 'ìˆ˜ì • ì™„ë£Œ'}
              </button>
            </div>
          </Modal>

          {/* ëª¨ë‹¬: ì‚­ì œ í™•ì¸ */}
          <Modal
            isOpen={modalState?.type === 'confirmDelete'}
            onClose={closeModal}
            title="ì‚­ì œ í™•ì¸"
          >
            <div className="space-y-6 text-center py-4">
              <div className="w-20 h-20 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto text-red-500 mb-4 animate-bounce">
                <Icon name="alert-triangle" size={40} />
              </div>
              <p className="text-slate-700 dark:text-slate-200 font-bold text-lg whitespace-pre-wrap leading-relaxed">
                {modalState?.data?.msg}
              </p>
              <div className="flex gap-4 pt-4">
                <button
                  onClick={closeModal}
                  className="flex-1 py-4 bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 rounded-2xl font-black text-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-all"
                >
                  ì·¨ì†Œ
                </button>
                <button
                  onClick={executeDelete}
                  className="flex-1 py-4 bg-red-500 hover:bg-red-600 text-white rounded-2xl font-black text-lg shadow-xl shadow-red-500/20 hover:scale-[1.02] transition-all"
                >
                  ì‚­ì œí•˜ê¸°
                </button>
              </div>
            </div>
          </Modal>

          {/* ëª¨ë‹¬: ì´ë¯¸ì§€ í™•ëŒ€ */}
          <Modal
            isOpen={modalState?.type === 'previewImage'}
            onClose={closeModal}
            title="ì´ë¯¸ì§€ í¬ê²Œ ë³´ê¸°"
            maxWidth="max-w-4xl"
          >
            <div className="p-2">
              <img src={modalState?.data} className="w-full rounded-2xl shadow-2xl" />
            </div>
          </Modal>

          {/* ëª¨ë‹¬: ìƒíƒœ ì•Œë¦¼ (Alert ëŒ€ì²´) */}
          <Modal
            isOpen={modalState?.type === 'status'}
            onClose={closeModal}
            title={modalState?.data?.title || "ì•Œë¦¼"}
          >
            <div className="space-y-6 text-center py-6">
              <div className={`w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 ${modalState?.data?.icon === 'check-circle' ? 'bg-emerald-100 text-emerald-500' :
                modalState?.data?.icon === 'alert-triangle' || modalState?.data?.icon === 'alert-circle' ? 'bg-red-100 text-red-500' :
                  'bg-brand-100 text-brand-500'
                }`}>
                <Icon name={modalState?.data?.icon || "info"} size={40} className={modalState?.data?.animate ? "animate-spin" : ""} />
              </div>
              <p className="text-slate-700 dark:text-slate-200 font-bold text-lg whitespace-pre-wrap leading-relaxed">
                {modalState?.data?.msg}
              </p>
              <button
                autoFocus
                onKeyDown={(e) => e.key === 'Enter' && closeModal()}
                onClick={closeModal}
                className="w-full py-4 bg-gradient-to-r from-brand-600 to-brand-700 hover:from-brand-700 hover:to-brand-800 text-white rounded-2xl font-black text-lg shadow-xl shadow-brand-900/30 transition-all transform active:scale-[0.98]"
              >
                í™•ì¸
              </button>
            </div>
          </Modal>

          {/* ëª¨ë‹¬: ì €ì¥ ê¸°ë¡ (íˆìŠ¤í† ë¦¬) */}
          <Modal
            isOpen={modalState?.type === 'history'}
            onClose={closeModal}
            title="ë°ì´í„° ì €ì¥ ê¸°ë¡ (ìµœëŒ€ 100ê°œ)"
            maxWidth="max-w-2xl"
          >
            <div className="space-y-4 max-h-[60vh] overflow-y-auto pr-2 scrollbar-hide">
              {history.length === 0 ? (
                <div className="text-center py-20 bg-slate-50 dark:bg-slate-900/50 rounded-3xl border border-dashed border-slate-200 dark:border-slate-800">
                  <Icon name="database-zap" size={48} className="mx-auto text-slate-300 mb-4" />
                  <p className="text-slate-500 font-bold">ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br />ë°ì´í„° ìˆ˜ì • ì‹œ 5ë¶„ë§ˆë‹¤ ìë™ ì €ì¥ë©ë‹ˆë‹¤.</p>
                </div>
              ) : (
                history.map((backup) => (
                  <div key={backup.id} className="group flex items-center justify-between p-5 rounded-2xl border border-slate-100 dark:border-slate-800 hover:border-brand-500/50 hover:bg-brand-50/30 dark:hover:bg-brand-900/10 transition-all">
                    <div className="flex items-center gap-4">
                      <div className={`p-3 rounded-xl ${backup.isAuto ? 'bg-slate-100 dark:bg-slate-800 text-slate-500' : 'bg-brand-100 dark:bg-brand-900 text-brand-500'}`}>
                        <Icon name={backup.isAuto ? "cpu" : "save"} size={20} />
                      </div>
                      <div>
                        <div className="flex items-center gap-2 mb-1">
                          <span className="font-black text-slate-800 dark:text-white">{backup.timestamp}</span>
                          {backup.isAuto && <span className="bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-400 text-xs px-2 py-0.5 rounded-full font-bold">ìë™ë°±ì—…</span>}
                        </div>
                        <p className="text-xs text-slate-400 font-medium">ë°ì´í„° ìŠ¤ëƒ…ìƒ· {backup.id}</p>
                      </div>
                    </div>
                    <button
                      onClick={() => restoreBackup(backup)}
                      className="px-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-sm font-black text-slate-700 dark:text-slate-200 hover:bg-brand-500 hover:text-white hover:border-brand-500 transition-all"
                    >
                      ë³µêµ¬í•˜ê¸°
                    </button>
                  </div>
                ))
              )}
            </div>
            <div className="mt-6 pt-6 border-t border-slate-100 dark:border-slate-800 flex justify-between items-center text-xs text-slate-400 font-bold">
              <p>ğŸ’¾ Ctrl + S ë‹¨ì¶•í‚¤ë¡œ ì¦‰ì‹œ ì €ì¥ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
              <button onClick={() => { if (confirm('ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { setHistory([]); localStorage.removeItem('roadmap_history'); } }} className="text-red-400 hover:text-red-600 transition-colors">ì „ì²´ ê¸°ë¡ ì‚­ì œ</button>
            </div>
          </Modal>

          <div className="max-w-[1750px] mx-auto p-4 md:p-8">
            <div className={`flex flex-col justify-center items-center mb-6 md:mb-10 p-6 md:p-10 rounded-[2rem] md:rounded-[3rem] shadow-2xl border-t-[8px] border-brand-600 gap-8 transition-all relative overflow-hidden ${darkMode ? 'bg-slate-900 shadow-brand-950/20' : 'bg-white'}`}>
              {/* Book Icon Removed */}

              <div className="flex flex-col items-center justify-center w-full text-center mt-6 md:mt-0 relative z-10">
                <input
                  value={pageTitle}
                  onChange={e => setPageTitle(e.target.value)}
                  spellCheck="false"
                  className="w-full text-3xl md:text-5xl font-black mb-2 tracking-tighter leading-tight text-slate-800 dark:text-white bg-transparent outline-none text-center"
                />
                <textarea
                  value={pageSubtitle}
                  onChange={e => { setPageSubtitle(e.target.value); handleAutoHeight(e); }}
                  spellCheck="false"
                  className="w-full text-slate-500 font-bold text-sm md:text-lg dark:text-gray-300 break-keep bg-transparent outline-none resize-none text-center overflow-hidden"
                  rows={1}
                  onFocus={handleAutoHeight}
                />
              </div>

              <div className="flex flex-col gap-3 w-full max-w-5xl mx-auto mt-8">
                {/* Row 1: Main Actions + Auth (Gradient descending from #af1d42) */}
                <div className="flex flex-wrap items-center justify-center gap-3">
                  <button
                    onClick={createBackup}
                    className="bg-[#af1d42] hover:bg-[#911836] text-white px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg transition-all active:scale-95 flex-1 min-w-[110px]"
                  >
                    <Icon name="save" size={18} />
                    <span>ì €ì¥í•˜ê¸°</span>
                  </button>
                  <button
                    onClick={downloadExcel}
                    className="bg-[#ba2d4e] hover:bg-[#9c2540] text-white px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg transition-all active:scale-95 flex-1 min-w-[110px]"
                  >
                    <Icon name="table-2" size={18} />
                    <span>Excel ë‹¤ìš´ë¡œë“œ</span>
                  </button>
                  <button
                    onClick={downloadImage}
                    className="bg-[#c53d5a] hover:bg-[#a7334b] text-white px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg transition-all active:scale-95 flex-1 min-w-[110px]"
                  >
                    <Icon name="image-plus" size={18} />
                    <span>ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</span>
                  </button>
                  {currentUser && (
                    <button
                      onClick={() => loadFromFirestore(currentUser, true)}
                      className="bg-[#cf4d66] hover:bg-[#b04055] text-white px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg transition-all active:scale-95 flex-1 min-w-[110px]"
                    >
                      <Icon name="cloud-download" size={18} />
                      <span>ë¶ˆëŸ¬ì˜¤ê¸°</span>
                    </button>
                  )}
                  {currentUser ? (
                    <button
                      onClick={handleLogout}
                      className="bg-[#da5d72] hover:bg-[#bc4e61] text-white px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg transition-all active:scale-95 flex-1 min-w-[110px]"
                    >
                      <Icon name="log-out" size={18} />
                      <span>ë¡œê·¸ì•„ì›ƒ</span>
                    </button>
                  ) : (
                    <button
                      onClick={handleLogin}
                      className="bg-[#da5d72] hover:bg-[#bc4e61] text-white px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg transition-all active:scale-95 flex-1 min-w-[110px] animate-pulse"
                    >
                      <Icon name="log-in" size={18} />
                      <span>ë¡œê·¸ì¸</span>
                    </button>
                  )}
                </div>

                {/* Row 2: Edit & View Actions (Lighter shades) */}
                <div className="flex flex-wrap items-center justify-center gap-3">
                  <button
                    onClick={() => { window._selectedType = 'textarea'; setModalState({ type: 'addRow' }); }}
                    className="bg-[#e46d7e] hover:bg-[#c65d6c] text-white px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg transition-all active:scale-95 flex-1 min-w-[110px]"
                  >
                    <Icon name="layers" size={18} />
                    <span>í–‰ ì¶”ê°€</span>
                  </button>
                  <button
                    onClick={() => setModalState({ type: 'history' })}
                    className="bg-[#ef7d8a] hover:bg-[#d16d78] text-white px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg transition-all active:scale-95 flex-1 min-w-[110px]"
                  >
                    <Icon name="history" size={18} />
                    <span>ë°±ì—… ê¸°ë¡ ê´€ë¦¬</span>
                  </button>
                  <button
                    onClick={() => setDarkMode(!darkMode)}
                    className="bg-[#f98d96] hover:bg-[#df7d85] text-white px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95 shadow-xl flex-1 min-w-[110px]"
                  >
                    {darkMode ? <Icon name="sun" size={18} className="text-yellow-200" /> : <Icon name="moon" size={18} />}
                    <span>{darkMode ? 'ë¼ì´íŠ¸ ëª¨ë“œ' : 'ë‹¤í¬ ëª¨ë“œ'}</span>
                  </button>
                </div>
              </div>
            </div>

            <div id="roadmap-container" ref={roadmapRef} className={`p-5 md:p-10 rounded-[2rem] md:rounded-[3.5rem] shadow-[0_40px_100px_-20px_rgba(0,0,0,0.3)] border border-slate-200/50 dark:border-slate-800/50 ${darkMode ? 'bg-slate-950' : 'bg-white'}`}>
              <div className="mb-8 md:mb-12 pb-6 md:pb-8 border-b-2 border-slate-100 dark:border-slate-900 flex flex-wrap gap-4 md:gap-8 items-stretch justify-between">
                <div className="flex flex-col gap-4 w-full">
                  <div className="flex flex-wrap gap-3 md:gap-6 items-stretch bg-slate-50 dark:bg-slate-900/80 p-3 md:p-5 rounded-[1.5rem] md:rounded-[2rem] border border-slate-200 dark:border-brand-900/30 shadow-inner w-full transition-all">
                    <div className="flex items-center gap-2 md:gap-3 px-3 md:px-4 py-2 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex-1 min-w-[140px] min-h-[60px]">
                      <Icon name="calendar" className="text-brand-600 dark:text-brand-400" size={18} />
                      <span className="font-black text-slate-500 dark:text-slate-400 uppercase text-[10px] md:text-[12px] tracking-widest shrink-0">ì—°ë„</span>
                      <input type="number" value={startYear} onChange={e => setStartYear(parseInt(e.target.value) || 0)} spellCheck="false" className="w-full bg-transparent text-center font-black text-brand-600 dark:text-brand-400 text-base md:text-xl outline-none" />
                    </div>
                    <div className="flex items-center gap-2 md:gap-3 px-3 md:px-4 py-2 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex-1 min-w-[140px] min-h-[60px]">
                      <Icon name="user" className="text-brand-400" size={18} />
                      <span className="font-black text-slate-500 dark:text-slate-400 uppercase text-[10px] md:text-[12px] tracking-widest shrink-0">ë‚˜ì´</span>
                      <input type="number" value={startAge} onChange={e => setStartAge(parseInt(e.target.value) || 0)} spellCheck="false" className="w-full bg-transparent text-center font-black text-brand-400 text-base md:text-xl outline-none" />
                    </div>
                    <div className="flex items-center gap-2 md:gap-3 px-3 md:px-4 py-2 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex-1 min-w-[140px] min-h-[60px]">
                      <Icon name="trending-up" className="text-emerald-500 dark:text-emerald-400" size={18} />
                      <span className="font-black text-slate-500 dark:text-slate-400 uppercase text-[10px] md:text-[12px] tracking-widest shrink-0">ìˆ˜ìµë¥ </span>
                      <div className="flex items-center justify-center w-full">
                        <input type="number" value={defaultReturn} onChange={e => setDefaultReturn(parseInt(e.target.value) || 0)} spellCheck="false" className="w-12 md:w-20 bg-transparent text-right font-black text-emerald-600 dark:text-emerald-400 text-base md:text-xl outline-none" />
                        <span className="font-black text-emerald-500 dark:text-emerald-400 text-base md:text-xl ml-1">%</span>
                      </div>
                    </div>
                    <div className="flex items-center gap-2 md:gap-3 px-3 md:px-4 py-2 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex-1 min-w-[140px] min-h-[60px]">
                      <Icon name="wallet" className="text-brand-500" size={18} />
                      <span className="font-black text-slate-500 dark:text-slate-400 uppercase text-[10px] md:text-[12px] tracking-widest shrink-0">ì €ì¶•ì•¡</span>
                      <input type="text" value={Number(defaultSavings).toLocaleString()} onChange={e => setDefaultSavings(Number(e.target.value.replace(/,/g, '')) || 0)} spellCheck="false" className="w-full bg-transparent text-center font-black text-brand-500 dark:text-brand-400 text-base md:text-xl outline-none" />
                    </div>
                    <div className="flex items-center gap-2 md:gap-3 px-3 md:px-4 py-2 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex-1 min-w-[140px] min-h-[60px]">
                      <Icon name="coins" className="text-brand-400 pulse-slow shrink-0" size={18} />
                      <span className="font-black text-slate-500 dark:text-slate-400 uppercase text-[10px] md:text-[12px] tracking-widest shrink-0">ë‹¨ìœ„</span>
                      <div className="flex gap-1 p-1 bg-slate-100 dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-700 w-full md:w-auto">
                        {['ì›', 'ì²œì›', 'ë§Œì›'].map(u => (
                          <button
                            key={u}
                            onClick={() => setSavingsUnit(u)}
                            className={`flex-1 md:px-3 py-1.5 rounded-md font-black text-[10px] md:text-xs transition-all ${savingsUnit === u
                              ? 'bg-brand-600 text-white shadow-md'
                              : 'text-slate-400 dark:text-slate-500 hover:text-brand-600 dark:hover:text-brand-400 hover:bg-white dark:hover:bg-slate-800 font-bold'
                              }`}
                          >
                            {u}
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>

                </div>
              </div>

              <div className="flex flex-col md:flex-row items-center gap-6 md:gap-8 mb-8 md:mb-14 p-6 md:p-8 rounded-[1.5rem] md:rounded-[2.5rem] border-2 border-brand-500/10 bg-gradient-to-r from-brand-500/5 via-transparent to-brand-500/5 relative overflow-hidden">
                <div className="absolute top-0 right-0 p-4 opacity-5 text-brand-900 hidden md:block">
                  <Icon name="target" size={120} />
                </div>
                <div className="w-20 h-20 md:w-24 md:h-24 bg-brand-600 rounded-[1.5rem] md:rounded-[2rem] flex items-center justify-center text-white font-black text-xl md:text-2xl shadow-2xl shrink-0 transition-transform hover:scale-105 shadow-brand-900/40">ëª©í‘œ</div>
                <div className="flex-1 space-y-2 w-full">
                  <input value={goalTitle} onChange={e => setGoalTitle(e.target.value)} spellCheck="false" className="w-full font-black text-2xl md:text-4xl bg-transparent outline-none tracking-tighter hover:bg-brand-500/5 rounded-xl transition-all p-2 text-slate-800 dark:text-white text-center md:text-left" />
                  <textarea
                    value={goalQuote}
                    onChange={e => { setGoalQuote(e.target.value); handleAutoHeight(e); }}
                    spellCheck="false"
                    className="w-full text-lg md:text-2xl italic bg-transparent outline-none resize-none font-bold text-slate-400 dark:text-white break-keep p-2 text-center md:text-left"
                    rows={1}
                    onFocus={handleAutoHeight}
                  />
                </div>
              </div>

              {/* ìì‚° ê³„ì‚° ìˆ˜ì‹ ë° ì‹œìŠ¤í…œ ì•ˆë‚´ ë°” */}
              <div id="formula-section" className="mb-10 space-y-4">
                <div className="p-6 md:p-8 rounded-[2rem] md:rounded-[2.5rem] bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-xl shadow-slate-200/50 dark:shadow-none relative overflow-hidden">
                  <div className="absolute left-0 top-0 w-2 h-full bg-brand-600"></div>

                  {/* ìˆ˜ì‹ ì˜ì—­ */}
                  <div className="flex flex-wrap items-center justify-center gap-4 md:gap-8 mb-8">
                    <div className="flex flex-col items-center gap-2">
                      <div className="bg-brand-50 dark:bg-brand-900/20 px-4 py-2 rounded-xl border border-brand-100 dark:border-brand-800">
                        <span className="font-black text-brand-700 dark:text-brand-300 text-base md:text-lg">ì—°ë§ìì‚°</span>
                      </div>
                    </div>

                    <span className="text-2xl font-black text-slate-300 dark:text-slate-700">=</span>

                    <div className="flex flex-col items-center gap-2">
                      <span className="font-bold text-slate-600 dark:text-slate-400 text-sm md:text-base">ì—°ì´ˆìì‚°</span>
                    </div>

                    <span className="text-2xl font-black text-brand-500/40">+</span>

                    <div className="flex items-center bg-slate-50 dark:bg-slate-800/50 px-5 py-3 rounded-2xl border-2 border-dashed border-slate-200 dark:border-slate-700 gap-3">
                      <span className="font-bold text-slate-600 dark:text-slate-400 text-sm md:text-base">íˆ¬ììì‚°</span>
                      <span className="text-xl font-black text-slate-300">Ã—</span>
                      <span className="font-bold text-emerald-500 dark:text-emerald-400 text-sm md:text-base">ìˆ˜ìµë¥ </span>
                    </div>

                    <span className="text-2xl font-black text-brand-500/40">+</span>

                    <div className="flex flex-col items-center gap-2">
                      <span className="font-bold text-orange-500 dark:text-orange-400 text-sm md:text-base">ì €ì¶•ì•¡</span>
                    </div>
                  </div>

                  {/* ì„¤ëª… ì˜ì—­ (ê·¸ë¦¬ë“œ) */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-slate-100 dark:border-slate-800 pt-6">
                    <div className="flex items-start gap-4 p-4 rounded-2xl bg-brand-500/5 border border-brand-500/10">
                      <div className="bg-brand-600 text-white p-2 rounded-xl shrink-0 shadow-lg shadow-brand-600/20">
                        <Icon name="refresh-cw" size={20} />
                      </div>
                      <div>
                        <h4 className="font-black text-slate-800 dark:text-white text-sm mb-1">ì‹¤ì‹œê°„ ìì‚° ì—°ë™ ì‹œìŠ¤í…œ</h4>
                        <p className="text-slate-500 dark:text-slate-100 text-xs md:text-sm leading-relaxed font-medium">
                          ì˜¬í•´ì˜ <span className="text-brand-600 font-bold">ì—°ë§ìì‚°</span>ì€ ìë™ìœ¼ë¡œ ë‚´ë…„ë„ì˜ <span className="text-brand-600 font-bold">ì—°ì´ˆìì‚°</span>ìœ¼ë¡œ ì´ì›”ë˜ì–´ 30ë…„ ë¡œë“œë§µì´ ìœ ê¸°ì ìœ¼ë¡œ ì™„ì„±ë©ë‹ˆë‹¤.
                        </p>
                      </div>
                    </div>

                    <div className="flex items-start gap-4 p-4 rounded-2xl bg-emerald-500/5 border border-emerald-500/10">
                      <div className="bg-emerald-500 text-white p-2 rounded-xl shrink-0 shadow-lg shadow-emerald-500/20">
                        <Icon name="edit-3" size={20} />
                      </div>
                      <div>
                        <h4 className="font-black text-slate-800 dark:text-white text-sm mb-1">ì „ í•­ëª© ììœ ë¡œìš´ ìˆ˜ê¸° ìˆ˜ì •</h4>
                        <p className="text-slate-500 dark:text-slate-100 text-xs md:text-sm leading-relaxed font-medium">
                          ì—°ì´ˆìì‚°, íˆ¬ììì‚°, ìˆ˜ìµë¥ , ì €ì¶•ì•¡ ë“±ì˜ í•­ëª©ì„ ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ìˆìœ¼ë©°, ìˆ˜ì • ì‹œ ì´í›„ ì—°ë„ ë°ì´í„°ì— ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* ì‹œì  ì´ë™ ì»¨íŠ¸ë¡¤ëŸ¬ (í‘œ ë°”ë¡œ ìœ„ë¡œ ì´ë™) */}
              <div id="timeline-controller" className="mb-10 flex flex-wrap items-center justify-center gap-4 px-2 py-6 bg-slate-50 dark:bg-slate-900/50 rounded-[2rem] border border-dashed border-slate-200 dark:border-slate-800">
                <span className="text-sm font-black uppercase tracking-widest text-brand-600 dark:text-brand-400 mr-2 bg-brand-500/10 px-5 py-2 rounded-full border border-brand-500/20">ë¡œë“œë§µ ì‹œì  ì´ë™</span>
                <div className="flex gap-3">
                  {[
                    { label: '1ë…„ ì „', val: -1, icon: 'chevron-left', color: 'bg-white dark:bg-slate-800 text-brand-600 dark:text-brand-400 border-slate-200 dark:border-slate-700' },
                    { label: 'ì˜¤ëŠ˜', val: 0, icon: 'refresh-cw', color: 'bg-brand-600 text-white z-10 shadow-lg shadow-brand-500/20' },
                    { label: '1ë…„ í›„', val: 1, icon: 'chevron-right', color: 'bg-white dark:bg-slate-800 text-brand-600 dark:text-brand-400 border-slate-200 dark:border-slate-700' }
                  ].map(btn => (
                    <button
                      key={btn.label}
                      onClick={() => {
                        takeSnapshot();
                        if (btn.val === 0) {
                          const todayYear = new Date().getFullYear();
                          const diff = todayYear - startYear;
                          setStartYear(todayYear);
                          setStartAge(prev => prev + diff);
                        } else {
                          setStartYear(prev => prev + btn.val);
                          setStartAge(prev => prev + btn.val);
                        }
                      }}
                      className={`flex items-center justify-center px-6 py-3 rounded-2xl text-sm font-black transition-all active:scale-95 border ${btn.color} hover:border-brand-500 hover:scale-105 w-full md:w-auto`}
                    >
                      {btn.label}
                    </button>
                  ))}
                </div>
              </div>

              {[0, 10, 20].map(startIndex => renderTable(startIndex))}
            </div>
          </div>
        </div >
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>

</html>